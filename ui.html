<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .plugin-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: 16px;
      gap: 16px;
      box-sizing: border-box;
    }
    
    .collection-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: calc(100% - 0px);
      margin: 0;
      padding: 0;
    }
    
    .collection-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      margin: 0;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .collection-select {
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .collection-select:hover {
      border-color: #007AFF;
    }
    
    .collection-select:focus {
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .collection-select option {
      padding: 8px;
      font-size: 14px;
    }
    
    .text-counter-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px 0;
      background: #ffffff;
      border-radius: 12px;
      flex: 1;
      min-height: 120px;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      min-width: 0;
    }
    
    .text-counter-number {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      font-size: 48px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }
    
    .text-counter-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 14px;
      height: 40px;
      width: 100%;
      line-height: 1.4;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      outline: none;
      box-sizing: border-box;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .button-scan {
      background: #f3f4f6;
      color: #374151;
      border-color: #d1d5db;
    }
    
    .button-scan:hover:not(:disabled) {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .button-scan:focus {
      box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
    }
    
    .button-process {
      background: #007AFF;
      color: #ffffff;
      border-color: #007AFF;
    }
    
    .button-process:hover:not(:disabled) {
      background: #0056CC;
      border-color: #0056CC;
    }
    
    .button-process:focus {
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .button-cancel {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }
    
    .button-cancel:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .button-cancel:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .button-create {
      background: #10b981;
      color: #ffffff;
      border-color: #10b981;
    }
    
    .button-create:hover:not(:disabled) {
      background: #059669;
      border-color: #059669;
    }
    
    .button-create:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .progress-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 8px;
      position: relative;
      height: 61px;
    }
    
    .progress-bar {
      width: 100px;
      height: 6px;
      background: rgba(120, 120, 128, 0.12);
      border-radius: 500px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #00C7BE;
      border-radius: 500px;
      transition: width 0.3s ease;
    }
    
    .status-message {
      padding: 6px 0;
      border-radius: 4px;
      font-size: 11px;
      text-align: center;
      display: none;
      margin-top: 6px;
      flex-shrink: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .status-message.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }
    
    .status-message.error {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    
    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="plugin-container">
                <!-- Collection Selection -->
                <div class="collection-container">
                  <h3 class="collection-label">Variable Collection</h3>
                  <select class="collection-select" id="collectionSelect">
                    <option value="" disabled selected>Select a collection.....</option>
                  </select>
                </div>
    
    <!-- Text Counter -->
    <div class="text-counter-container" id="textCounterContainer">
      <div class="text-counter-number" id="textCounterNumber">0</div>
      <div class="text-counter-label" id="textCounterLabel">Text layers scanned</div>
    </div>
    
    <!-- Progress Container (hidden by default) -->
    <div class="progress-container hidden" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
    
    <!-- Button Container -->
    <div class="button-container">
      <button class="button button-scan" id="scanButton">üîç Rescan Text Layers</button>
      <button class="button button-process hidden" id="processButton">Process Text Layers</button>
      <button class="button button-cancel hidden" id="cancelButton">Stop Processing</button>
      <button class="button button-create hidden" id="createButton">Create New Collection</button>
    </div>
    
    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>
  </div>
  
  <script>
    // State management
    let currentState = 'startup'; // startup, collection-selected, processing, completed
    let textLayers = [];
    let selectedCollection = null;
    let scanResults = null;
    let collections = [];
    let isProcessing = false;
    
    // UI Elements
    const elements = {
      collectionSelect: document.getElementById('collectionSelect'),
      textCounterNumber: document.getElementById('textCounterNumber'),
      textCounterLabel: document.getElementById('textCounterLabel'),
      textCounterContainer: document.getElementById('textCounterContainer'),
      progressContainer: document.getElementById('progressContainer'),
      progressFill: document.getElementById('progressFill'),
      scanButton: document.getElementById('scanButton'),
      processButton: document.getElementById('processButton'),
      cancelButton: document.getElementById('cancelButton'),
      createButton: document.getElementById('createButton'),
      statusMessage: document.getElementById('statusMessage')
    };
    
    // State management functions
    function setState(newState) {
      currentState = newState;
      updateUI();
    }
    
    function updateUI() {
      // Hide all buttons first
      elements.scanButton.classList.add('hidden');
      elements.processButton.classList.add('hidden');
      elements.cancelButton.classList.add('hidden');
      elements.createButton.classList.add('hidden');
      elements.progressContainer.classList.add('hidden');
      
      // Show appropriate elements based on state
      switch (currentState) {
        case 'startup':
          elements.scanButton.classList.remove('hidden');
          elements.createButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers scanned';
          break;
          
        case 'collection-selected':
          elements.scanButton.classList.remove('hidden');
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers scanned';
          break;
          
        case 'processing':
          elements.cancelButton.classList.remove('hidden');
          elements.progressContainer.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers to process';
          break;
          
        case 'completed':
          elements.scanButton.classList.remove('hidden');
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers scanned';
          break;
      }
    }
    
    // Collection selection
    function populateCollectionSelect() {
      elements.collectionSelect.innerHTML = '<option value="" disabled selected>Select a collection.....</option>';
      
      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id;
        option.textContent = collection.name;
        elements.collectionSelect.appendChild(option);
      });
    }
    
    function selectCollection(collectionId, collectionName) {
      selectedCollection = collectionId;
      elements.collectionSelect.value = collectionId;
      
      if (scanResults && scanResults.validCount > 0) {
        setState('collection-selected');
      } else {
        setState('startup');
      }
    }
    
    function updateTextCounter(count, label) {
      elements.textCounterNumber.textContent = count;
      elements.textCounterLabel.textContent = label;
    }
    
    function updateProgress(percentage) {
      elements.progressFill.style.width = percentage + '%';
    }
    
    function showStatus(message, type = 'info') {
      elements.statusMessage.textContent = message;
      elements.statusMessage.className = `status-message ${type}`;
      elements.statusMessage.style.display = 'block';
      
      // Auto-hide after 3 seconds for success/info messages
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          elements.statusMessage.style.display = 'none';
        }, 3000);
      }
    }
    
    function hideStatus() {
      elements.statusMessage.style.display = 'none';
    }
    
    // Event listeners
    elements.collectionSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        const selectedOption = e.target.options[e.target.selectedIndex];
        selectCollection(e.target.value, selectedOption.textContent);
      }
    });
    
    elements.scanButton.addEventListener('click', () => {
      hideStatus();
      parent.postMessage({ pluginMessage: { type: 'scan-text-layers' } }, '*');
    });
    
    elements.processButton.addEventListener('click', () => {
      if (!selectedCollection) {
        showStatus('Please select a variable collection', 'error');
        return;
      }
      hideStatus();
      setState('processing');
      isProcessing = true;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables', 
          collectionId: selectedCollection 
        } 
      }, '*');
    });
    
    elements.cancelButton.addEventListener('click', () => {
      isProcessing = false;
      setState('collection-selected');
      showStatus('Processing cancelled', 'info');
    });
    
    elements.createButton.addEventListener('click', () => {
      hideStatus();
      parent.postMessage({ pluginMessage: { type: 'create-default-collection' } }, '*');
    });
    
    // Message handling
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'collections-loaded') {
        collections = msg.collections;
        populateCollectionSelect();
        if (collections.length === 0) {
          setState('startup');
        }
      }
      
      if (msg.type === 'collection-created') {
        collections = msg.collections;
        populateCollectionSelect();
        selectCollection(msg.collectionId, 'Text to String');
        showStatus('Collection created successfully!', 'success');
      }
      
      if (msg.type === 'text-layers-found') {
        textLayers = msg.layers;
        scanResults = { validCount: msg.validCount, totalCount: msg.totalCount };
        
        updateTextCounter(msg.validCount, 'Text layers scanned');
        
        if (msg.validCount === 0) {
          showStatus(`No valid text layers found. Found ${msg.totalCount} text layers total, but none are suitable for variable creation.`, 'error');
          setState('startup');
        } else {
          if (selectedCollection) {
            setState('collection-selected');
          } else {
            setState('startup');
          }
          showStatus(`Found ${msg.validCount} valid text layers ready for processing`, 'success');
        }
      }
      
      if (msg.type === 'progress-update') {
        if (isProcessing) {
          updateTextCounter(msg.remaining, 'Text layers to process');
          updateProgress(msg.progress);
        }
      }
      
      if (msg.type === 'variables-created') {
        isProcessing = false;
        setState('completed');
        
        let message = `‚úÖ Processing Complete!\n`;
        message += `‚Ä¢ Created: ${msg.created} new variables\n`;
        message += `‚Ä¢ Connected: ${msg.connected} to existing variables\n`;
        if (msg.skipped > 0) {
          message += `‚Ä¢ Skipped: ${msg.skipped} empty layers\n`;
        }
        if (msg.errors > 0) {
          message += `‚Ä¢ Errors: ${msg.errors} failed to process\n`;
        }
        message += `\nTotal processed: ${msg.totalProcessed} text layers`;
        
        showStatus(message, msg.errors > 0 ? 'error' : 'success');
        updateTextCounter(scanResults.validCount, 'Text layers scanned');
      }
      
      if (msg.type === 'error') {
        isProcessing = false;
        setState('startup');
        showStatus(msg.message, 'error');
      }
    };
    
    // Initialize
    parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
    parent.postMessage({ pluginMessage: { type: 'scan-text-layers' } }, '*');
    setState('startup');
  </script>
</body>
</html>