<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Convert Figma text layers to string variables">
  <title>Stringify - Text to Variables</title>
  <style>
    /* ============================================================================
       RESET AND BASE STYLES
    ============================================================================ */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* ============================================================================
       ACCESSIBILITY STYLES
    ============================================================================ */
    
    /* Screen reader only class for accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Focus management */
    *:focus {
      outline: 2px solid #007AFF;
      outline-offset: 2px;
    }
    
    /* ============================================================================
       LAYOUT CONTAINERS
    ============================================================================ */
    
    .plugin-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      padding: 16px;
      gap: 16px;
      box-sizing: border-box;
    }
    
    .collection-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    .text-counter-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px 0;
      background: #ffffff;
      border-radius: 12px;
      flex: 1;
      min-height: 120px;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      min-width: 0;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ============================================================================
       PROGRESS INDICATORS
    ============================================================================ */
    
    .progress-container {
      display: none;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .progress-container.visible {
      display: flex;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007AFF 0%, #0056CC 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-text {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      margin: 0;
    }

    /* ============================================================================
       STATUS MESSAGES
    ============================================================================ */
    
    .status-message {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      text-align: left;
      display: none;
      margin-top: 8px;
      flex-shrink: 0;
      width: 100%;
      border: 1px solid transparent;
      box-sizing: border-box;
    }
    
    .status-message.visible {
      display: block;
    }
    
    .status-message.error {
      background: #ffeaea;
      color: #d32f2f;
      border-color: #ffcdd2;
    }
    
    .status-message.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border-color: #c3e6c3;
    }
    
    .status-message.warning {
      background: #fff8e1;
      color: #f57f17;
      border-color: #ffecb3;
    }
    
    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border-color: #bbdefb;
    }

    /* ============================================================================
       FORM ELEMENTS
    ============================================================================ */
    
    .collection-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      margin: 0;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .collection-select {
      width: 100%;
      height: 44px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .collection-select:hover {
      border-color: #9ca3af;
    }
    
    .collection-select:focus {
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .collection-select:disabled {
      background: #f9fafb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* ============================================================================
       TEXT COUNTER
    ============================================================================ */
    
    .text-counter-number {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      font-size: 48px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }
    
    .text-counter-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }

    /* ============================================================================
       BUTTONS
    ============================================================================ */
    
    .button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 14px;
      height: 40px;
      width: 100%;
      line-height: 1.4;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      outline: none;
      box-sizing: border-box;
      position: relative;
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .button-scan {
      background: #f3f4f6;
      color: #374151;
      border-color: #d1d5db;
    }
    
    .button-scan:hover:not(:disabled) {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .button-scan:focus {
      box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
    }
    
    .button-process {
      background: #007AFF;
      color: #ffffff;
      border-color: #007AFF;
    }
    
    .button-process:hover:not(:disabled) {
      background: #0056CC;
      border-color: #0056CC;
    }
    
    .button-process:focus {
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .button-cancel {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }
    
    .button-cancel:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .button-cancel:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .button-create {
      background: #10b981;
      color: #ffffff;
      border-color: #10b981;
    }
    
    .button-create:hover:not(:disabled) {
      background: #059669;
      border-color: #059669;
    }
    
    .button-create:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    /* ============================================================================
       LOADING STATES
    ============================================================================ */
    
    .button.loading {
      position: relative;
      color: transparent;
    }
    
    .button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .button-scan.loading::after {
      border-top-color: #374151;
    }
    
    .button-process.loading::after {
      border-top-color: #ffffff;
    }
    
    .button-cancel.loading::after {
      border-top-color: #ffffff;
    }
    
    .button-create.loading::after {
      border-top-color: #ffffff;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============================================================================
       UTILITY CLASSES
    ============================================================================ */
    
    .hidden {
      display: none !important;
    }
    
    .visible {
      display: block !important;
    }
    
    .flex-visible {
      display: flex !important;
    }
  </style>
</head>
<body>
  <main class="plugin-container" role="main">
    <!-- Collection Selection Section -->
    <section class="collection-container" aria-labelledby="collection-heading">
      <h3 id="collection-heading" class="collection-label">Variable Collection</h3>
      <select 
        class="collection-select" 
        id="collectionSelect"
        aria-describedby="collection-description"
        aria-label="Select variable collection"
      >
        <option value="" disabled selected>Select a collection...</option>
      </select>
      <div id="collection-description" class="sr-only">
        Choose the variable collection where new string variables will be created
      </div>
    </section>

    <!-- Text Counter Section -->
    <section class="text-counter-container" id="textCounterContainer" aria-live="polite">
      <div class="text-counter-number" id="textCounterNumber">0</div>
      <div class="text-counter-label" id="textCounterLabel">Text layers scanned</div>
    </section>

    <!-- Progress Container -->
    <div class="progress-container" id="progressContainer" aria-live="polite">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">Processing...</div>
    </div>

    <!-- Status Messages -->
    <div class="status-message" id="statusMessage" role="alert" aria-live="assertive"></div>

    <!-- Action Buttons -->
    <section class="button-container">
      <button 
        class="button button-scan" 
        id="scanButton"
        aria-describedby="scan-description"
        aria-label="Scan text layers"
      >
        🔍 Rescan Text Layers
      </button>
      <div id="scan-description" class="sr-only">
        Scan the current page for text layers that can be converted to variables
      </div>
      
      <button 
        class="button button-process hidden" 
        id="processButton"
        aria-describedby="process-description"
        aria-label="Process text layers"
      >
        Process Text Layers
      </button>
      <div id="process-description" class="sr-only">
        Convert found text layers to string variables in the selected collection
      </div>
      
      <button class="button button-cancel hidden" id="cancelButton" aria-label="Stop processing">
        Stop Processing
      </button>
      
      <button 
        class="button button-create hidden" 
        id="createButton"
        aria-describedby="create-description"
        aria-label="Create new collection"
      >
        Create New Collection
      </button>
      <div id="create-description" class="sr-only">
        Create a new variable collection for storing text variables
      </div>
    </section>
  </main>

  <script>
    // ============================================================================
    // ENHANCED STATE MANAGEMENT
    // ============================================================================
    
    let currentState = 'startup';
    let textLayers = [];
    let selectedCollection = null;
    let scanResults = null;
    let collections = [];
    let isProcessing = false;
    let processingTimeout = null;
    
    // UI Elements
    const elements = {
      collectionSelect: document.getElementById('collectionSelect'),
      textCounterNumber: document.getElementById('textCounterNumber'),
      textCounterLabel: document.getElementById('textCounterLabel'),
      textCounterContainer: document.getElementById('textCounterContainer'),
      progressContainer: document.getElementById('progressContainer'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      scanButton: document.getElementById('scanButton'),
      processButton: document.getElementById('processButton'),
      cancelButton: document.getElementById('cancelButton'),
      createButton: document.getElementById('createButton'),
      statusMessage: document.getElementById('statusMessage')
    };
    
    // ============================================================================
    // STATE MANAGEMENT FUNCTIONS
    // ============================================================================
    
    function setState(newState) {
      if (currentState === newState) return;
      
      console.log(`State change: ${currentState} -> ${newState}`);
      currentState = newState;
      updateUI();
    }
    
    function updateUI() {
      // Clear any existing timeouts
      if (processingTimeout) {
        clearTimeout(processingTimeout);
        processingTimeout = null;
      }
      
      // Reset button states
      Object.values(elements).forEach(el => {
        if (el && el.classList) {
          el.classList.remove('loading');
          el.disabled = false;
        }
      });
      
      // Hide all dynamic elements
      elements.scanButton.classList.add('hidden');
      elements.processButton.classList.add('hidden');
      elements.cancelButton.classList.add('hidden');
      elements.createButton.classList.add('hidden');
      elements.progressContainer.classList.remove('visible');
      
      // Show appropriate elements based on state
      switch (currentState) {
        case 'startup':
          elements.scanButton.classList.remove('hidden');
          // Show create button when no collection is selected
          elements.createButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers scanned';
          break;
          
        case 'collection-selected':
          elements.scanButton.classList.remove('hidden');
          // Show process button when collection is selected
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers ready';
          break;
          
        case 'processing':
          elements.cancelButton.classList.remove('hidden');
          elements.progressContainer.classList.add('visible');
          elements.textCounterLabel.textContent = 'Processing...';
          // Hide both process and create buttons during processing
          elements.processButton.classList.add('hidden');
          elements.createButton.classList.add('hidden');
          isProcessing = true;
          break;
          
        case 'completed':
          elements.scanButton.classList.remove('hidden');
          // Show process button after completion
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Processing completed';
          isProcessing = false;
          break;
          
        case 'error':
          elements.scanButton.classList.remove('hidden');
          // Show create button on error
          elements.createButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Ready to scan';
          isProcessing = false;
          break;
      }
      
      // Update button text and state based on collection selection
      updateDynamicButton();
    }
    
    function updateDynamicButton() {
      // Don't update buttons during processing
      if (currentState === 'processing') {
        return;
      }
      
      if (selectedCollection && scanResults && scanResults.validCount > 0) {
        // Collection selected and text layers found - show process button
        elements.processButton.textContent = `Process ${scanResults.validCount} Text Layers`;
        elements.processButton.disabled = false;
        elements.createButton.classList.add('hidden');
        elements.processButton.classList.remove('hidden');
      } else if (selectedCollection) {
        // Collection selected but no text layers - show process button (disabled)
        elements.processButton.textContent = 'No Text Layers Found';
        elements.processButton.disabled = true;
        elements.createButton.classList.add('hidden');
        elements.processButton.classList.remove('hidden');
      } else {
        // No collection selected - show create button
        elements.createButton.textContent = 'Create New Collection';
        elements.createButton.disabled = false;
        elements.processButton.classList.add('hidden');
        elements.createButton.classList.remove('hidden');
      }
    }
    
    // ============================================================================
    // COLLECTION MANAGEMENT
    // ============================================================================
    
    function populateCollectionSelect() {
      const select = elements.collectionSelect;
      select.innerHTML = '<option value="" disabled selected>Select a collection...</option>';
      
      if (collections.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No collections found';
        option.disabled = true;
        select.appendChild(option);
        return;
      }
      
      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id;
        const variableCount = collection.variables ? collection.variables.length : 0;
        option.textContent = `${collection.name} (${variableCount} variables)`;
        select.appendChild(option);
      });
    }
    
    function selectCollection(collectionId) {
      selectedCollection = collectionId;
      elements.collectionSelect.value = collectionId;
      
      // Update the dynamic button based on new selection
      updateDynamicButton();
      
      if (scanResults && scanResults.validCount > 0) {
        setState('collection-selected');
      } else {
        setState('startup');
      }
    }
    
    // ============================================================================
    // UI FEEDBACK FUNCTIONS
    // ============================================================================
    
    function updateTextCounter(count, label = null) {
      elements.textCounterNumber.textContent = count;
      if (label) {
        elements.textCounterLabel.textContent = label;
      }
    }
    
    function updateProgress(percentage, remaining = null) {
      elements.progressFill.style.width = percentage + '%';
      elements.progressContainer.setAttribute('aria-valuenow', percentage);
      
      if (remaining !== null) {
        updateTextCounter(remaining, `${remaining} remaining`);
        elements.progressText.textContent = `Processing... ${remaining} items remaining`;
      }
    }
    
    function showStatus(message, type = 'info', duration = null) {
      const statusEl = elements.statusMessage;
      statusEl.textContent = message;
      statusEl.className = `status-message ${type} visible`;
      
      // Set appropriate ARIA live region urgency
      statusEl.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      
      if (duration && type !== 'error') {
        setTimeout(() => hideStatus(), duration);
      }
    }
    
    function hideStatus() {
      elements.statusMessage.classList.remove('visible');
    }
    
    function handleError(error, context = '') {
      console.error(`Plugin error ${context}:`, error);
      const userMessage = typeof error === 'string' ? error : 'An unexpected error occurred';
      showStatus(userMessage, 'error');
      setState('error');
    }
    
    function setButtonLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
      } else {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
    
    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    
    elements.collectionSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        selectCollection(e.target.value);
        hideStatus();
      } else {
        // Collection selection cleared
        selectedCollection = null;
        updateDynamicButton();
        setState('startup');
        hideStatus();
      }
    });
    
    elements.scanButton.addEventListener('click', () => {
      setButtonLoading(elements.scanButton, true);
      hideStatus();
      sendMessage({ type: 'scan-text-layers' });
    });
    
    elements.processButton.addEventListener('click', () => {
      if (!selectedCollection) {
        showStatus('Please select a variable collection first', 'error');
        return;
      }
      
      if (!scanResults || scanResults.validCount === 0) {
        showStatus('No valid text layers found. Please scan first.', 'error');
        return;
      }
      
      hideStatus();
      setState('processing');
      sendMessage({ 
        type: 'create-variables', 
        collectionId: selectedCollection 
      });
    });
    
    elements.cancelButton.addEventListener('click', () => {
      if (isProcessing) {
        setState('collection-selected');
        showStatus('Processing cancelled', 'warning', 3000);
      }
    });
    
    elements.createButton.addEventListener('click', () => {
      setButtonLoading(elements.createButton, true);
      hideStatus();
      sendMessage({ type: 'create-default-collection' });
    });
    
    // ============================================================================
    // MESSAGE HANDLING
    // ============================================================================
    
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      try {
        handleMessage(msg);
      } catch (error) {
        handleError(error, `handling message ${msg.type}`);
      }
    };
    
    function handleMessage(msg) {
      // Reset loading states
      Object.values(elements).forEach(el => {
        if (el && el.classList) {
          el.classList.remove('loading');
          el.disabled = false;
        }
      });
      
      switch (msg.type) {
        case 'collections-loaded':
          collections = msg.collections;
          populateCollectionSelect();
          updateDynamicButton(); // Update button based on current state
          if (collections.length === 0) {
            showStatus('No variable collections found. Create one to get started.', 'warning');
            setState('startup');
          }
          break;
          
        case 'collection-created':
          collections = msg.collections;
          populateCollectionSelect();
          selectCollection(msg.collectionId);
          showStatus('Collection created successfully!', 'success', 3000);
          break;
          
        case 'text-layers-found':
          textLayers = msg.layers;
          scanResults = { validCount: msg.validCount, totalCount: msg.totalCount };
          
          updateTextCounter(msg.validCount);
          updateDynamicButton(); // Update button based on scan results
          
          if (msg.validCount === 0) {
            const message = msg.totalCount > 0 
              ? `Found ${msg.totalCount} text layers, but none are suitable for variables.`
              : 'No text layers found on the current page.';
            showStatus(message, 'warning');
            setState('startup');
          } else {
            const message = `Found ${msg.validCount} text layers ready for processing`;
            showStatus(message, 'success', 3000);
            
            if (selectedCollection) {
              setState('collection-selected');
            } else {
              setState('startup');
            }
          }
          break;
          
        case 'progress-update':
          updateProgress(msg.progress, msg.remaining);
          break;
          
        case 'variables-created':
          const result = msg.result;
          setState('completed');
          
          // Create detailed success message
          const parts = [];
          if (result.created > 0) parts.push(`${result.created} new variables created`);
          if (result.connected > 0) parts.push(`${result.connected} connected to existing`);
          if (result.skipped > 0) parts.push(`${result.skipped} skipped`);
          if (result.errors > 0) parts.push(`${result.errors} errors`);
          
          const message = parts.length > 0 ? parts.join(', ') : 'Processing completed';
          showStatus(`✅ Success: ${message}`, 'success', 5000);
          updateTextCounter(result.totalProcessed, 'Variables processed');
          break;
          
        case 'error':
          handleError(msg.message);
          break;
          
        default:
          console.warn('Unknown message type:', msg.type);
      }
    }
    
    function sendMessage(message) {
      parent.postMessage({ pluginMessage: message }, '*');
    }
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    function initializePlugin() {
      try {
        sendMessage({ type: 'get-collections' });
        sendMessage({ type: 'scan-text-layers' });
        setState('startup');
      } catch (error) {
        handleError(error, 'initializing plugin');
      }
    }
    
    // Initialize plugin
    initializePlugin();
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !isProcessing) {
        // Refresh data when plugin becomes visible
        sendMessage({ type: 'get-collections' });
        sendMessage({ type: 'scan-text-layers' });
      }
    });
  </script>
</body>
</html>