<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 16px;
      margin: 0;
      background: #ffffff;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    .header h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1e1e1e;
    }
    
    .header p {
      margin: 0;
      font-size: 12px;
      color: #8c8c8c;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 500;
      color: #1e1e1e;
    }
    
    .collection-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      background: #ffffff;
    }
    
    .collection-select:focus {
      outline: none;
      border-color: #0c8ce9;
    }
    
    .button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .button-primary {
      background: #0c8ce9;
      color: white;
    }
    
    .button-primary:hover {
      background: #0a7bc7;
    }
    
    .button-secondary {
      background: #f3f3f3;
      color: #1e1e1e;
      margin-top: 8px;
    }
    
    .button-secondary:hover {
      background: #e5e5e5;
    }
    
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
    
    .status.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }
    
    .status.error {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Stringify</h2>
    <p>Convert text layers to variables</p>
  </div>
  
  <div class="section">
    <h3>Variable Collection</h3>
    <select id="collectionSelect" class="collection-select">
      <option value="">Select a collection...</option>
    </select>
    <button id="createCollectionButton" class="button button-secondary" style="margin-top: 8px; width: 100%;">Create "Text to String" Collection</button>
  </div>
  
  <div class="section">
    <button id="scanButton" class="button button-primary">Scan Text Layers</button>
    <button id="createVariablesButton" class="button button-secondary" disabled>Create Variables</button>
  </div>
  
  <div class="section">
    <div id="scanResults" style="display: none;">
      <h3>Scan Results</h3>
      <div id="scanStats" class="status info"></div>
    </div>
  </div>
  
  <div id="status" class="status"></div>
  
  <script>
    let textLayers = [];
    let selectedCollection = null;
    let scanResults = null;
    
    // Load variable collections
    function loadCollections() {
      parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
    }
    
    // Show status message
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }
    
    // Hide status message
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    // Show scan results
    function showScanResults(validCount, totalCount) {
      const scanResults = document.getElementById('scanResults');
      const scanStats = document.getElementById('scanStats');
      
      scanStats.innerHTML = `
        <strong>Found ${validCount} valid text layers</strong><br>
        <small>Out of ${totalCount} total text layers on the page</small>
      `;
      scanResults.style.display = 'block';
    }
    
    // Event listeners
    document.getElementById('collectionSelect').onchange = (e) => {
      selectedCollection = e.target.value;
      updateCreateButton();
    };
    
    document.getElementById('createCollectionButton').onclick = () => {
      hideStatus();
      parent.postMessage({ pluginMessage: { type: 'create-default-collection' } }, '*');
    };
    
    document.getElementById('scanButton').onclick = () => {
      hideStatus();
      parent.postMessage({ pluginMessage: { type: 'scan-text-layers' } }, '*');
    };
    
    document.getElementById('createVariablesButton').onclick = () => {
      if (!selectedCollection) {
        showStatus('Please select a variable collection', 'error');
        return;
      }
      hideStatus();
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables', 
          collectionId: selectedCollection 
        } 
      }, '*');
    };
    
    function updateCreateButton() {
      const button = document.getElementById('createVariablesButton');
      if (selectedCollection && scanResults && scanResults.validCount > 0) {
        button.disabled = false;
        button.textContent = `Process ${scanResults.validCount} Text Layers`;
      } else if (selectedCollection) {
        button.disabled = true;
        button.textContent = 'Scan Text Layers First';
      } else {
        button.disabled = true;
        button.textContent = 'Select Collection First';
      }
    }
    
    // Listen for messages from the plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'collections-loaded') {
        const select = document.getElementById('collectionSelect');
        select.innerHTML = '<option value="">Select a collection...</option>';
        
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          select.appendChild(option);
        });
        updateCreateButton();
      }
      
      if (msg.type === 'collection-created') {
        // Refresh collections and select the new one
        const select = document.getElementById('collectionSelect');
        select.innerHTML = '<option value="">Select a collection...</option>';
        
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          if (collection.id === msg.collectionId) {
            option.selected = true;
            selectedCollection = collection.id;
          }
          select.appendChild(option);
        });
        
        showStatus('Collection created successfully!', 'success');
        updateCreateButton();
      }
      
      if (msg.type === 'text-layers-found') {
        textLayers = msg.layers;
        scanResults = { validCount: msg.validCount, totalCount: msg.totalCount };
        
        showScanResults(msg.validCount, msg.totalCount);
        
        if (msg.validCount === 0) {
          showStatus(`No valid text layers found. Found ${msg.totalCount} text layers total, but none are suitable for variable creation.`, 'error');
        } else {
          showStatus(`Found ${msg.validCount} valid text layers ready for processing`, 'success');
        }
        
        updateCreateButton();
      }
      
      if (msg.type === 'variables-created') {
        let message = `✅ Processing Complete!\n`;
        message += `• Created: ${msg.created} new variables\n`;
        message += `• Connected: ${msg.connected} to existing variables\n`;
        if (msg.skipped > 0) {
          message += `• Skipped: ${msg.skipped} empty layers\n`;
        }
        if (msg.errors > 0) {
          message += `• Errors: ${msg.errors} failed to process\n`;
        }
        message += `\nTotal processed: ${msg.totalProcessed} text layers`;
        
        showStatus(message, msg.errors > 0 ? 'error' : 'success');
      }
      
      if (msg.type === 'error') {
        showStatus(msg.message, 'error');
      }
    };
    
    // Initialize
    loadCollections();
  </script>
</body>
</html>