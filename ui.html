<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Convert Figma text layers to string variables">
  <title>Stringify - Text to Variables</title>
  <style>
    /* ============================================================================
       RESET AND BASE STYLES
    ============================================================================ */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* ============================================================================
       ACCESSIBILITY STYLES
    ============================================================================ */
    
    /* Screen reader only class for accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Focus management */
    *:focus {
      outline: 2px solid #007AFF;
      outline-offset: 2px;
    }
    
    /* ============================================================================
       LAYOUT CONTAINERS
    ============================================================================ */
    
    .plugin-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      padding: 16px;
      gap: 16px;
      box-sizing: border-box;
    }
    
    .collection-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    .text-counter-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px 0;
      background: #ffffff;
      border-radius: 12px;
      flex: 1;
      min-height: 120px;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      min-width: 0;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ============================================================================
       PROGRESS INDICATORS
    ============================================================================ */
    
    .progress-container {
      display: none;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .progress-container.visible {
      display: flex;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007AFF 0%, #0056CC 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-text {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      margin: 0;
    }

    /* ============================================================================
       STATUS MESSAGES
    ============================================================================ */
    
    .status-message {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      text-align: left;
      display: none;
      margin-top: 8px;
      flex-shrink: 0;
      width: 100%;
      border: 1px solid transparent;
      box-sizing: border-box;
    }
    
    .status-message.visible {
      display: block;
    }
    
    .status-message.error {
      background: #ffeaea;
      color: #d32f2f;
      border-color: #ffcdd2;
    }
    
    .status-message.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border-color: #c3e6c3;
    }
    
    .status-message.warning {
      background: #fff8e1;
      color: #f57f17;
      border-color: #ffecb3;
    }
    
    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border-color: #bbdefb;
    }

    /* ============================================================================
       FORM ELEMENTS
    ============================================================================ */
    
    .collection-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      margin: 0;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    .collection-select {
      width: 100%;
      height: 44px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .collection-select:hover {
      border-color: #9ca3af;
    }
    
    .collection-select:focus {
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .collection-select:disabled {
      background: #f9fafb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* ============================================================================
       TEXT COUNTER
    ============================================================================ */
    
    .text-counter-number {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      font-size: 48px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }
    
    .text-counter-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }

    /* ============================================================================
       BUTTONS
    ============================================================================ */
    
    .button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 14px;
      height: 40px;
      width: 100%;
      line-height: 1.4;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      outline: none;
      box-sizing: border-box;
      position: relative;
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .button-scan {
      background: #f3f4f6;
      color: #374151;
      border-color: #d1d5db;
    }
    
    .button-scan:hover:not(:disabled) {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .button-scan:focus {
      box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
    }
    
    .button-process {
      background: #007AFF;
      color: #ffffff;
      border-color: #007AFF;
    }
    
    .button-process:hover:not(:disabled) {
      background: #0056CC;
      border-color: #0056CC;
    }
    
    .button-process:focus {
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .button-cancel {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }
    
    .button-cancel:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .button-cancel:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .button-create {
      background: #10b981;
      color: #ffffff;
      border-color: #10b981;
    }
    
    .button-create:hover:not(:disabled) {
      background: #059669;
      border-color: #059669;
    }
    
    .button-create:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    /* ============================================================================
       LOADING STATES
    ============================================================================ */
    
    .button.loading {
      position: relative;
      color: transparent;
    }
    
    .button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .button-scan.loading::after {
      border-top-color: #374151;
    }
    
    .button-process.loading::after {
      border-top-color: #ffffff;
    }
    
    .button-cancel.loading::after {
      border-top-color: #ffffff;
    }
    
    .button-create.loading::after {
      border-top-color: #ffffff;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============================================================================
       TAB NAVIGATION
    ============================================================================ */
    
    .tab-navigation {
      display: flex;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
      gap: 4px;
    }
    
    .tab-button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .tab-button:hover:not(.active) {
      background: #e5e7eb;
      color: #374151;
    }
    
    .tab-button.active {
      background: #ffffff;
      color: #000000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .tab-button:focus {
      outline: 2px solid #007AFF;
      outline-offset: 2px;
    }
    
    .ghost-count {
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      line-height: 1.2;
    }
    
    .ghost-count:empty {
      display: none;
    }
    
    /* ============================================================================
       TAB CONTENT
    ============================================================================ */
    
    .tab-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }
    
    .tab-content.hidden {
      display: none;
    }
    
    /* ============================================================================
       GHOSTBUSTER STYLES
    ============================================================================ */
    
    .ghost-status-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    .ghost-status {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px 0;
      background: #ffffff;
      border-radius: 12px;
      flex: 1;
      min-height: 120px;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      min-width: 0;
    }
    
    .ghost-number {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      font-size: 48px;
      line-height: 1.21;
      color: #ef4444;
      text-align: center;
      margin: 0;
    }
    
    .ghost-number[data-count="0"] {
      color: #10b981;
    }
    
    .ghost-label {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.21;
      color: #000000;
      text-align: center;
      margin: 0;
    }
    
    .ghost-actions-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .ghost-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .button-clear {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }
    
    .button-clear:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .button-clear:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .ghost-list-container {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      min-height: 0;
    }
    
    .ghost-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .ghost-item {
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #ffffff;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .ghost-item.clickable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .ghost-item.clickable:hover {
      background: #f8f9fa;
      border-color: #007AFF;
      box-shadow: 0 2px 4px rgba(0, 122, 255, 0.1);
    }
    
    .ghost-item.clickable:active {
      background: #e3f2fd;
      transform: translateY(1px);
    }
    
    .ghost-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .ghost-layer-name {
      font-weight: 600;
      color: #000000;
    }
    
    .ghost-binding-type {
      background: #f3f4f6;
      color: #6b7280;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .ghost-text-preview {
      color: #6b7280;
      font-style: italic;
      margin-top: 4px;
      word-break: break-word;
    }
    
    .ghost-item.empty {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 24px;
    }
    
    .ghost-item.empty .ghost-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    /* ============================================================================
       UTILITY CLASSES
    ============================================================================ */
    
    .hidden {
      display: none !important;
    }
    
    .visible {
      display: block !important;
    }
    
    .flex-visible {
      display: flex !important;
    }
  </style>
</head>
<body>
  <main class="plugin-container" role="main">
    <!-- Tab Navigation -->
    <div class="tab-navigation" role="tablist">
      <button class="tab-button active" data-tab="stringify" role="tab" aria-selected="true" aria-controls="stringifyTab">
        Stringify
      </button>
      <button class="tab-button" data-tab="ghostbuster" role="tab" aria-selected="false" aria-controls="ghostbusterTab">
        Ghostbuster <span class="ghost-count" id="ghostCount">0</span>
      </button>
    </div>

    <!-- Stringify Tab Content -->
    <div class="tab-content" id="stringifyTab" role="tabpanel" aria-labelledby="stringify-tab">
      <!-- Collection Selection Section -->
      <section class="collection-container" aria-labelledby="collection-heading">
      <h3 id="collection-heading" class="collection-label">Variable Collection</h3>
      <select 
        class="collection-select" 
        id="collectionSelect"
        aria-describedby="collection-description"
        aria-label="Select variable collection"
      >
        <option value="" disabled selected>Select a collection...</option>
      </select>
      <div id="collection-description" class="sr-only">
        Choose the variable collection where new string variables will be created
      </div>
    </section>

    <!-- Text Counter Section -->
    <section class="text-counter-container" id="textCounterContainer" aria-live="polite">
      <div class="text-counter-number" id="textCounterNumber">0</div>
      <div class="text-counter-label" id="textCounterLabel">Text layers scanned</div>
    </section>

    <!-- Progress Container -->
    <div class="progress-container" id="progressContainer" aria-live="polite">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">Processing...</div>
    </div>

    <!-- Status Messages -->
    <div class="status-message" id="statusMessage" role="alert" aria-live="assertive"></div>

    <!-- Action Buttons -->
    <section class="button-container">
      <button 
        class="button button-scan" 
        id="scanButton"
        aria-describedby="scan-description"
        aria-label="Scan text layers"
      >
        üîç Rescan
      </button>
      <div id="scan-description" class="sr-only">
        Scan the current page for text layers that can be converted to variables
      </div>
      
      <button 
        class="button button-process hidden" 
        id="processButton"
        aria-describedby="process-description"
        aria-label="Process text layers"
      >
        Process Text Layers
      </button>
      <div id="process-description" class="sr-only">
        Convert found text layers to string variables in the selected collection
      </div>
      
      <button class="button button-cancel hidden" id="cancelButton" aria-label="Stop processing">
        Stop Processing
      </button>
      
      <button 
        class="button button-create hidden" 
        id="createButton"
        aria-describedby="create-description"
        aria-label="Create new collection"
      >
        Create New Collection
      </button>
      <div id="create-description" class="sr-only">
        Create a new variable collection for storing text variables
      </div>
    </section>
    </div>

    <!-- Ghostbuster Tab Content -->
    <div class="tab-content hidden" id="ghostbusterTab" role="tabpanel" aria-labelledby="ghostbuster-tab">
      <!-- Ghost Status Section -->
      <section class="ghost-status-container" aria-labelledby="ghost-status-heading">
        <div class="ghost-status">
          <div class="ghost-number" id="ghostNumber">0</div>
          <div class="ghost-label" id="ghostLabel">Ghost variables found</div>
        </div>
      </section>

      <!-- Ghost Actions Section -->
      <section class="ghost-actions-container">
        <div class="ghost-actions">
          <button class="button button-scan" id="scanGhostsButton" aria-describedby="scan-ghosts-description">
            üîç Rescan Page
          </button>
          <div id="scan-ghosts-description" class="sr-only">
            Scan the current page for ghost variable connections
          </div>
          
          <button class="button button-clear hidden" id="clearGhostsButton" aria-describedby="clear-ghosts-description" disabled>
            üëª Clear Ghost Variables
          </button>
          <div id="clear-ghosts-description" class="sr-only">
            Remove all detected ghost variable connections
          </div>
        </div>
      </section>

      <!-- Ghost List Section -->
      <section class="ghost-list-container" id="ghostListContainer">
        <div class="ghost-list" id="ghostList" aria-live="polite">
          <!-- Ghost variables will be listed here -->
        </div>
      </section>
    </div>
  </main>

  <script>
    // ============================================================================
    // ENHANCED STATE MANAGEMENT
    // ============================================================================
    
    let currentState = 'startup';
    let textLayers = [];
    let selectedCollection = null;
    let scanResults = null;
    let collections = [];
    let isProcessing = false;
    let processingTimeout = null;
    
    // Tab and Ghostbuster state
    let activeTab = 'stringify';
    let ghostVariables = [];
    let isScanningGhosts = false;
    
    // UI Elements
    const elements = {
      // Existing elements
      collectionSelect: document.getElementById('collectionSelect'),
      textCounterNumber: document.getElementById('textCounterNumber'),
      textCounterLabel: document.getElementById('textCounterLabel'),
      textCounterContainer: document.getElementById('textCounterContainer'),
      progressContainer: document.getElementById('progressContainer'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      scanButton: document.getElementById('scanButton'),
      processButton: document.getElementById('processButton'),
      cancelButton: document.getElementById('cancelButton'),
      createButton: document.getElementById('createButton'),
      statusMessage: document.getElementById('statusMessage'),
      
      // Tab elements
      stringifyTab: document.getElementById('stringifyTab'),
      ghostbusterTab: document.getElementById('ghostbusterTab'),
      stringifyTabButton: document.querySelector('[data-tab="stringify"]'),
      ghostbusterTabButton: document.querySelector('[data-tab="ghostbuster"]'),
      
      // Ghostbuster elements
      ghostCount: document.getElementById('ghostCount'),
      ghostNumber: document.getElementById('ghostNumber'),
      ghostLabel: document.getElementById('ghostLabel'),
      scanGhostsButton: document.getElementById('scanGhostsButton'),
      clearGhostsButton: document.getElementById('clearGhostsButton'),
      ghostList: document.getElementById('ghostList')
    };
    
    // ============================================================================
    // STATE MANAGEMENT FUNCTIONS
    // ============================================================================
    
    function setState(newState) {
      if (currentState === newState) return;
      
      console.log(`State change: ${currentState} -> ${newState}`);
      currentState = newState;
      updateUI();
    }
    
    function switchTab(tabName) {
      if (activeTab === tabName) {
        console.log(`Tab switch: Already on ${tabName}, skipping refresh`);
        return;
      }
      
      console.log(`Tab switch: ${activeTab} -> ${tabName}`);
      activeTab = tabName;
      updateTabUI();
      
      // Refresh data when switching to Stringify tab
      if (tabName === 'stringify') {
        console.log('Switching to Stringify tab - triggering refresh...');
        refreshStringifyData();
      }
    }
    
    function updateTabUI() {
      // Update tab buttons
      elements.stringifyTabButton.classList.toggle('active', activeTab === 'stringify');
      elements.ghostbusterTabButton.classList.toggle('active', activeTab === 'ghostbuster');
      elements.stringifyTabButton.setAttribute('aria-selected', activeTab === 'stringify');
      elements.ghostbusterTabButton.setAttribute('aria-selected', activeTab === 'ghostbuster');
      
      // Update tab content
      elements.stringifyTab.classList.toggle('hidden', activeTab !== 'stringify');
      elements.ghostbusterTab.classList.toggle('hidden', activeTab !== 'ghostbuster');
      
      // Update UI based on active tab
      if (activeTab === 'ghostbuster') {
        updateGhostbusterUI();
      }
    }
    
    function refreshStringifyData() {
      console.log('Refreshing Stringify data...');
      console.log('Current selectedCollection:', selectedCollection);
      
      // Show loading state
      setButtonLoading(elements.scanButton, true);
      
      // Refresh collections and text layers
      console.log('Sending get-collections message...');
      sendMessage({ type: 'get-collections' });
      
      console.log('Sending scan-text-layers message with selectedCollectionId:', selectedCollection);
      sendMessage({ 
        type: 'scan-text-layers',
        selectedCollectionId: selectedCollection
      });
    }
    
    function updateGhostbusterUI() {
      // Update ghost count display
      const count = ghostVariables.length;
      elements.ghostNumber.textContent = count;
      elements.ghostNumber.setAttribute('data-count', count);
      elements.ghostCount.textContent = count > 0 ? count : '';
      
      // Update ghost label
      elements.ghostLabel.textContent = count === 1 ? 'Ghost variable found' : 'Ghost variables found';
      
      // Update clear button
      if (count > 0) {
        elements.clearGhostsButton.classList.remove('hidden');
        elements.clearGhostsButton.disabled = false;
        elements.clearGhostsButton.textContent = `üëª Clear ${count} Ghost Variable${count !== 1 ? 's' : ''}`;
      } else {
        elements.clearGhostsButton.classList.add('hidden');
        elements.clearGhostsButton.disabled = true;
      }
      
      // Update ghost list
      updateGhostList();
    }
    
    function updateGhostList() {
      const ghostList = elements.ghostList;
      ghostList.innerHTML = '';
      
      if (ghostVariables.length === 0) {
        const emptyItem = document.createElement('div');
        emptyItem.className = 'ghost-item empty';
        emptyItem.innerHTML = `
          <span class="ghost-icon">üëª</span>
          <div>No ghost variables found</div>
          <div style="font-size: 11px; margin-top: 4px;">Your text layers are clean!</div>
        `;
        ghostList.appendChild(emptyItem);
        return;
      }
      
      ghostVariables.forEach(ghost => {
        const ghostItem = document.createElement('div');
        ghostItem.className = 'ghost-item clickable';
        ghostItem.innerHTML = `
          <div class="ghost-item-header">
            <span class="ghost-layer-name">${escapeHtml(ghost.nodeName)}</span>
            <span class="ghost-binding-type">${ghost.bindingType}</span>
          </div>
          <div class="ghost-text-preview">"${escapeHtml(ghost.textContent.substring(0, 50))}${ghost.textContent.length > 50 ? '...' : ''}"</div>
        `;
        
        // Add click handler to select the layer
        ghostItem.addEventListener('click', () => {
          sendMessage({ type: 'select-ghost-layer', nodeId: ghost.nodeId });
        });
        
        ghostList.appendChild(ghostItem);
      });
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function updateUI() {
      // Clear any existing timeouts
      if (processingTimeout) {
        clearTimeout(processingTimeout);
        processingTimeout = null;
      }
      
      // Reset button states
      Object.values(elements).forEach(el => {
        if (el && el.classList) {
          el.classList.remove('loading');
          el.disabled = false;
        }
      });
      
      // Re-enable collection select (will be disabled again in processing state if needed)
      elements.collectionSelect.disabled = false;
      elements.collectionSelect.style.opacity = '1';
      
      // Hide all dynamic elements
      elements.scanButton.classList.add('hidden');
      elements.processButton.classList.add('hidden');
      elements.cancelButton.classList.add('hidden');
      elements.createButton.classList.add('hidden');
      elements.progressContainer.classList.remove('visible');
      
      // Show appropriate elements based on state
      switch (currentState) {
        case 'startup':
          elements.scanButton.classList.remove('hidden');
          // Show create button when no collection is selected
          elements.createButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers scanned';
          break;
          
        case 'collection-selected':
          elements.scanButton.classList.remove('hidden');
          // Show process button when collection is selected
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Text layers ready';
          break;
          
        case 'processing':
          elements.cancelButton.classList.remove('hidden');
          elements.progressContainer.classList.add('visible');
          elements.textCounterLabel.textContent = 'Processing...';
          // Hide both process and create buttons during processing
          elements.processButton.classList.add('hidden');
          elements.createButton.classList.add('hidden');
          // Disable collection selection during processing
          elements.collectionSelect.disabled = true;
          elements.collectionSelect.style.opacity = '0.6';
          isProcessing = true;
          break;
          
        case 'completed':
          elements.scanButton.classList.remove('hidden');
          // Show process button after completion
          elements.processButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Processing completed';
          isProcessing = false;
          break;
          
        case 'error':
          elements.scanButton.classList.remove('hidden');
          // Show create button on error
          elements.createButton.classList.remove('hidden');
          elements.textCounterLabel.textContent = 'Ready to scan';
          isProcessing = false;
          break;
      }
      
      // Update button text and state based on collection selection
      updateDynamicButton();
    }
    
    function updateDynamicButton() {
      // Don't update buttons during processing
      if (currentState === 'processing') {
        return;
      }
      
      if (selectedCollection && scanResults && scanResults.validCount > 0) {
        // Collection selected and text layers found - show process button
        elements.processButton.textContent = `Process ${scanResults.validCount} Text Layers`;
        elements.processButton.disabled = false;
        elements.createButton.classList.add('hidden');
        elements.processButton.classList.remove('hidden');
      } else if (selectedCollection) {
        // Collection selected but no text layers - show process button (disabled)
        elements.processButton.textContent = 'No Text Layers Found';
        elements.processButton.disabled = true;
        elements.createButton.classList.add('hidden');
        elements.processButton.classList.remove('hidden');
      } else {
        // No collection selected - show create button
        elements.createButton.textContent = 'Create New Collection';
        elements.createButton.disabled = false;
        elements.processButton.classList.add('hidden');
        elements.createButton.classList.remove('hidden');
      }
    }
    
    // ============================================================================
    // COLLECTION MANAGEMENT
    // ============================================================================
    
    function populateCollectionSelect() {
      const select = elements.collectionSelect;
      select.innerHTML = '<option value="" disabled selected>Select a collection...</option>';
      
      if (collections.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No collections found';
        option.disabled = true;
        select.appendChild(option);
        return;
      }
      
      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id;
        const variableCount = collection.variables ? collection.variables.length : 0;
        option.textContent = `${collection.name} (${variableCount} variables)`;
        select.appendChild(option);
      });
    }
    
    function selectCollection(collectionId) {
      selectedCollection = collectionId;
      elements.collectionSelect.value = collectionId;
      
      // Update the dynamic button based on new selection
      updateDynamicButton();
      
      if (scanResults && scanResults.validCount > 0) {
        setState('collection-selected');
      } else {
        setState('startup');
      }
    }
    
    // ============================================================================
    // UI FEEDBACK FUNCTIONS
    // ============================================================================
    
    function updateTextCounter(count, label = null) {
      elements.textCounterNumber.textContent = count;
      if (label) {
        elements.textCounterLabel.textContent = label;
      }
    }
    
    function updateProgress(percentage, remaining = null) {
      elements.progressFill.style.width = percentage + '%';
      elements.progressContainer.setAttribute('aria-valuenow', percentage);
      
      if (remaining !== null) {
        updateTextCounter(remaining, `${remaining} remaining`);
        elements.progressText.textContent = `Processing... ${remaining} items remaining`;
      }
    }
    
    function showStatus(message, type = 'info', duration = null) {
      const statusEl = elements.statusMessage;
      statusEl.textContent = message;
      statusEl.className = `status-message ${type} visible`;
      
      // Set appropriate ARIA live region urgency
      statusEl.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      
      if (duration && type !== 'error') {
        setTimeout(() => hideStatus(), duration);
      }
    }
    
    function hideStatus() {
      elements.statusMessage.classList.remove('visible');
    }
    
    function handleError(error, context = '') {
      console.error(`Plugin error ${context}:`, error);
      const userMessage = typeof error === 'string' ? error : 'An unexpected error occurred';
      showStatus(userMessage, 'error');
      setState('error');
      
      // Clear loading states
      setButtonLoading(elements.scanButton, false);
    }
    
    function setButtonLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
      } else {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
    
    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    
    elements.collectionSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        selectCollection(e.target.value);
        hideStatus();
      } else {
        // Collection selection cleared
        selectedCollection = null;
        updateDynamicButton();
        setState('startup');
        hideStatus();
      }
    });
    
    elements.scanButton.addEventListener('click', () => {
      setButtonLoading(elements.scanButton, true);
      hideStatus();
      sendMessage({ 
        type: 'scan-text-layers',
        selectedCollectionId: selectedCollection
      });
    });
    
    elements.processButton.addEventListener('click', () => {
      if (!selectedCollection) {
        showStatus('Please select a variable collection first', 'error');
        return;
      }
      
      if (!scanResults || scanResults.validCount === 0) {
        showStatus('No valid text layers found. Please scan first.', 'error');
        return;
      }
      
      hideStatus();
      setState('processing');
      sendMessage({ 
        type: 'create-variables', 
        collectionId: selectedCollection 
      });
    });
    
    elements.cancelButton.addEventListener('click', () => {
      if (isProcessing) {
        setState('collection-selected');
        showStatus('Processing cancelled', 'warning', 3000);
      }
    });
    
    elements.createButton.addEventListener('click', () => {
      setButtonLoading(elements.createButton, true);
      hideStatus();
      sendMessage({ type: 'create-default-collection' });
    });
    
    // Tab navigation event listeners
    elements.stringifyTabButton.addEventListener('click', () => {
      if (activeTab === 'stringify') {
        // If already on stringify tab, force refresh
        console.log('Already on Stringify tab - forcing refresh...');
        refreshStringifyData();
      } else {
        switchTab('stringify');
      }
    });
    
    elements.ghostbusterTabButton.addEventListener('click', () => {
      switchTab('ghostbuster');
    });
    
    // Ghostbuster event listeners
    elements.scanGhostsButton.addEventListener('click', () => {
      setButtonLoading(elements.scanGhostsButton, true);
      hideStatus();
      sendMessage({ type: 'scan-ghost-variables' });
    });
    
    elements.clearGhostsButton.addEventListener('click', () => {
      if (ghostVariables.length === 0) return;
      
      const confirmed = confirm(
        `Are you sure you want to clear ${ghostVariables.length} ghost variable${ghostVariables.length !== 1 ? 's' : ''}?\n\nThis will remove the broken variable connections from your text layers. This action cannot be undone.`
      );
      
      if (confirmed) {
        setButtonLoading(elements.clearGhostsButton, true);
        hideStatus();
        const ghostIds = ghostVariables.map(ghost => ghost.nodeId);
        sendMessage({ type: 'clear-ghost-variables', ghostIds });
      }
    });
    
    // ============================================================================
    // MESSAGE HANDLING
    // ============================================================================
    
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      try {
        handleMessage(msg);
      } catch (error) {
        handleError(error, `handling message ${msg.type}`);
      }
    };
    
    function handleMessage(msg) {
      // Reset loading states
      Object.values(elements).forEach(el => {
        if (el && el.classList) {
          el.classList.remove('loading');
          el.disabled = false;
        }
      });
      
      switch (msg.type) {
        case 'collections-loaded':
          collections = msg.collections;
          populateCollectionSelect();
          updateDynamicButton(); // Update button based on current state
          if (collections.length === 0) {
            showStatus('No variable collections found. Create one to get started.', 'warning');
            setState('startup');
          }
          break;
          
        case 'collection-created':
          collections = msg.collections;
          populateCollectionSelect();
          selectCollection(msg.collectionId);
          showStatus('Collection created successfully!', 'success', 3000);
          break;
          
        case 'text-layers-found':
          textLayers = msg.layers;
          scanResults = { validCount: msg.validCount, totalCount: msg.totalCount };
          
          // Clear loading state
          setButtonLoading(elements.scanButton, false);
          
          updateTextCounter(msg.validCount, 'Text layers ready');
          updateDynamicButton(); // Update button based on scan results
          
          if (msg.validCount === 0) {
            const message = msg.totalCount > 0 
              ? `Found ${msg.totalCount} text layers, but none are suitable for variables (may be hidden, locked, or already bound to variables).`
              : 'No text layers found on the current page.';
            showStatus(message, 'warning');
            setState('startup');
          } else {
            const message = `Found ${msg.validCount} text layers ready for processing`;
            showStatus(message, 'success', 3000);
            
            if (selectedCollection) {
              setState('collection-selected');
            } else {
              setState('startup');
            }
          }
          break;
          
        case 'progress-update':
          updateProgress(msg.progress, msg.remaining);
          break;
          
        case 'variables-created':
          const variablesResult = msg.result;
          setState('completed');
          
          // Create detailed success message
          const parts = [];
          if (variablesResult.created > 0) parts.push(`${variablesResult.created} new variables created`);
          if (variablesResult.connected > 0) parts.push(`${variablesResult.connected} connected to existing`);
          if (variablesResult.skipped > 0) parts.push(`${variablesResult.skipped} skipped`);
          if (variablesResult.errors > 0) parts.push(`${variablesResult.errors} errors`);
          
          const message = parts.length > 0 ? parts.join(', ') : 'Processing completed';
          showStatus(`‚úÖ Success: ${message}`, 'success', 5000);
          updateTextCounter(variablesResult.totalProcessed, 'Variables processed');
          
          // Auto-rescan after processing to show updated eligible text layers
          setTimeout(() => {
            sendMessage({ 
              type: 'scan-text-layers',
              selectedCollectionId: selectedCollection
            });
          }, 1000); // Wait 1 second to let the success message show
          break;
          
        case 'collection-invalid':
          // Collection no longer exists - reset to default state
          selectedCollection = null;
          elements.collectionSelect.value = '';
          populateCollectionSelect();
          updateDynamicButton();
          setState('startup');
          showStatus(msg.message, 'warning', 5000);
          
          // Clear loading state
          setButtonLoading(elements.scanButton, false);
          break;
          
        case 'error':
          handleError(msg.message);
          break;
          
        case 'ghost-variables-found':
          ghostVariables = msg.ghosts || [];
          updateGhostbusterUI();
          showStatus(`Found ${ghostVariables.length} ghost variable${ghostVariables.length !== 1 ? 's' : ''}`, 'info', 3000);
          break;
          
        case 'ghost-clear-complete':
          const clearResult = msg.result;
          ghostVariables = [];
          updateGhostbusterUI();
          
          const successMessage = `‚úÖ Cleared ${clearResult.successfullyCleared} ghost variable${clearResult.successfullyCleared !== 1 ? 's' : ''}`;
          showStatus(successMessage, 'success', 5000);
          
          if (clearResult.failed > 0) {
            showStatus(`Warning: ${clearResult.failed} ghost variable${clearResult.failed !== 1 ? 's' : ''} could not be cleared`, 'warning', 5000);
          }
          break;
          
        case 'ghost-scan-error':
          handleError(msg.error);
          break;
          
        default:
          console.warn('Unknown message type:', msg.type);
      }
    }
    
    function sendMessage(message) {
      parent.postMessage({ pluginMessage: message }, '*');
    }
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    function initializePlugin() {
      try {
        // Initialize tab system
        updateTabUI();
        
        // Initialize stringify functionality
        sendMessage({ type: 'get-collections' });
        sendMessage({ 
          type: 'scan-text-layers',
          selectedCollectionId: selectedCollection
        });
        setState('startup');
        
        // Initialize ghostbuster with initial scan
        sendMessage({ type: 'scan-ghost-variables' });
      } catch (error) {
        handleError(error, 'initializing plugin');
      }
    }
    
    // Initialize plugin
    initializePlugin();
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !isProcessing) {
        // Refresh data when plugin becomes visible
        sendMessage({ type: 'get-collections' });
        sendMessage({ 
          type: 'scan-text-layers',
          selectedCollectionId: selectedCollection
        });
      }
    });
  </script>
</body>
</html>